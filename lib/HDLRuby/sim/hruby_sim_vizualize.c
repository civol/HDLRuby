#include <stdio.h>
#include "hruby_sim.h"


/**
 *  The HDLRuby simulation visualization engine, to be used with C code
 *  generated by hruby_low2c. 
 **/

/* The print function pointers. */

PrinterS printer;


/** Initializes the visualization printer engine.
 *  @param print_time the time printer
 *  @param print_name the name printer
 *  @param print_value the value printer
 *  @param print_signal the signal state printer. */
void init_visualizer(void (*print_time)(unsigned long long), 
                     void (*print_name)(Object),
                     void (*print_value)(Value),
                     void (*print_signal)(SignalI)) {
    printer.print_time = print_time; 
    printer.print_name = print_name; 
    printer.print_value = print_value; 
    printer.print_signal = print_signal; 
}

                    


/* The default printing functions. */

/** Prints the time.
 *  @param time the time to show. */
static void default_print_time(unsigned long long time) {
    printf("# %llups",time);
}

/** Prints the time and goes to the next line.
 *  @par1am time the time to show. */
static void default_println_time(unsigned long long time) {
    default_print_time(time);
    printf("\n");
}

/** Prints the name of an object.
 *  @param object the object to print the name. */
static void default_print_name(Object object) {
    /* Recurse on the owner if any. */
    // printf("owner=%p\n",object->owner);
    if (object->owner != NULL) {
        default_print_name(object->owner);
        printf("::");
    }
    /* Depending on the kind of object. */
    switch(object->kind) {
        case SYSTEMT:
        case SIGNALI:
        case SCOPE:
        case SYSTEMI:
            /* Print the name if name. */
            /* Trick: SystemT, SignalI, Scope and SystemI have the
             * field name at the same place. */
            if (((SystemI)object)->name != NULL) {
                printf("%s",((SystemI)object)->name);
            }
        default: /* Nothing to do */
            break;
    }
}

/** Prints a value.
 *  @param value the value to print */
static void default_print_value(Value value) {
    if (value->numeric) {
        unsigned long long width = type_width(value->type);
        unsigned long long mask = 1ULL << (width-1);
        for(; mask > 0; mask >>= 1) {
            printf("%d",(value->data_int & mask) != 0);
        }
    } else {
        /* Display a bitstring value. */
        int i;
        int width = type_width(value->type);
        char* data = value->data_str;
        if (value->capacity == 0) {
            /* The value is empty, therefore undefined. */
            for(i=width; i>0; --i) {
                printf("u");
            }
        }
        else {
            /* The value is not empty. */
            for(i=width; i>0; --i) {
                printf("%c",data[i-1]);
            } 
        }
    }
}

/** Prints a signal.
 *  @param signal the signal to show */
static void default_print_signal(SignalI signal) {
    default_print_name((Object)signal);
    printf(": ");
    default_print_value(signal->f_value);
}

/** Prints a signal and goes to the next line.
 *  @param signal the signal to show */
static void default_println_signal(SignalI signal) {
    default_print_signal(signal);
    printf("\n");
}



/* Set up the visualizer. */

/** Set up the default vizualization engine.
 *  @param name the name of the vizualization. */
void init_default_visualizer(char* name) {
    /* Initialize the vizualizer printer engine. */
    init_visualizer(&default_println_time,
                    &default_print_name,
                    &default_print_value,
                    &default_println_signal);
}
